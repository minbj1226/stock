{% extends "base.html" %}

{% block content %}
<div style="display: flex; justify-content: space-between;">
    <!-- ì™¼ìª½ ì˜ì—­: ì£¼ë¬¸ ë° ê³„ì¢Œ ì •ë³´ -->
    <div style="width: 60%;">
        <h2>ğŸ“ˆ ì£¼ì‹ ê±°ë˜</h2>

        <div class="account-info">
            <h3>ğŸ“Œ ê³„ì¢Œ ì •ë³´</h3>
            <p><strong>ê³„ì¢Œ ë²ˆí˜¸:</strong> {{ balance_info.account_number }}</p>
            <p><strong>ì˜ˆìˆ˜ê¸ˆ:</strong> {{ balance_info.deposits.KRW.amount|floatformat:0 }} ì›</p>
            <p><strong>ì´ ë§¤ì… ê¸ˆì•¡:</strong> {{ balance_info.purchase_amount|floatformat:0 }} ì›</p>
            <p><strong>í˜„ì¬ í‰ê°€ ê¸ˆì•¡:</strong> {{ balance_info.current_amount|floatformat:0 }} ì›</p>
            <p><strong>ì´ ìˆ˜ìµ:</strong> {{ balance_info.profit|floatformat:0 }} ì›</p>
            <p><strong>ì´ ìˆ˜ìµë¥ :</strong> {{ balance_info.profit_rate|floatformat:2 }} %</p>
        </div>

        <form method="post">
            <h3>ğŸ“Œ ê±°ë˜</h3>
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit">ì£¼ë¬¸í•˜ê¸°</button>
        </form>

        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    </div>

    <!-- ì˜¤ë¥¸ìª½ ì˜ì—­: ì£¼ë¬¸ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸ -->
    <div style="width: 35%;">
        <h3>ğŸ“œ ì£¼ë¬¸ ë‚´ì—­</h3>
        {% if orders %}
        <ul>
            {% for order in orders %}
            <li>
                {{ order.stock_name }} ({{ order.quantity }}ì£¼) - {{ order.transaction_type }}
                <form action="{% url 'stocks:cancel_order' order.id %}" method="post" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" onclick="return confirm('ì •ë§ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">â ì·¨ì†Œ</button>
                </form>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p>ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endif %}
    </div>
</div>

<hr>

<!-- ì¢…ëª© ì°¨íŠ¸ ê·¸ë˜í”„ -->
<h3>ğŸ“ˆ ì¢…ëª© ì°¨íŠ¸ ë³´ê¸°</h3>
<input type="text" id="stockNameInput" placeholder="ì¢…ëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
<button onclick="loadChart()">ê·¸ë˜í”„ ë³´ê¸°</button>
<div id="stockChart" style="height: 500px;"></div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    function loadChart() {
        const stockName = document.getElementById("stockNameInput").value;
        if (!stockName) {
            alert("ì¢…ëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        fetch(`/stocks/stock_chart_data/?stock_name=${encodeURIComponent(stockName)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }

                const trace = {
                    x: data.date,
                    open: data.open,
                    high: data.high,
                    low: data.low,
                    close: data.close,
                    type: 'candlestick',
                    xaxis: 'x',
                    yaxis: 'y'
                };

                const layout = {
                    title: `${stockName} ì°¨íŠ¸`,
                    dragmode: 'zoom',
                    showlegend: false,
                    xaxis: {
                        rangeslider: { visible: false },
                        tickformat: "%Y.%m.%d"
                    }
                };

                const config = {
                    displayModeBar: false
                };

                Plotly.newPlot('stockChart', [trace], layout, config);
            })
            .catch(err => {
                alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                console.error(err);
            });
    }
</script>

{% endblock %}