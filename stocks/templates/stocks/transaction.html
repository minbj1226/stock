{% extends "base.html" %}

{% block content %}
<div style="display: flex; justify-content: space-between;">
    <!-- 왼쪽 영역: 주문 및 계좌 정보 -->
    <div style="width: 60%;">
        <h2>📈 주식 거래</h2>

        <div class="account-info">
            <h3>📌 계좌 정보</h3>
            <p><strong>계좌 번호:</strong> {{ balance_info.account_number }}</p>
            <p><strong>예수금:</strong> {{ balance_info.deposits.KRW.amount|floatformat:0 }} 원</p>
            <p><strong>총 매입 금액:</strong> {{ balance_info.purchase_amount|floatformat:0 }} 원</p>
            <p><strong>현재 평가 금액:</strong> {{ balance_info.current_amount|floatformat:0 }} 원</p>
            <p><strong>총 수익:</strong> {{ balance_info.profit|floatformat:0 }} 원</p>
            <p><strong>총 수익률:</strong> {{ balance_info.profit_rate|floatformat:2 }} %</p>
        </div>

        <form method="post">
            <h3>📌 거래</h3>
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit">주문하기</button>
        </form>

        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    </div>

    <!-- 오른쪽 영역: 주문 내역 리스트 -->
    <div style="width: 35%;">
        <h3>📜 주문 내역</h3>
        {% if orders %}
        <ul>
            {% for order in orders %}
            <li>
                {{ order.stock_name }} ({{ order.quantity }}주) - {{ order.transaction_type }}
                <form action="{% url 'stocks:cancel_order' order.id %}" method="post" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" onclick="return confirm('정말 취소하시겠습니까?')">❎ 취소</button>
                </form>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p>주문 내역이 없습니다.</p>
        {% endif %}
    </div>
</div>

<hr>

<!-- 종목 차트 그래프 -->
<h3>📈 종목 차트 보기</h3>
<input type="text" id="stockNameInput" placeholder="종목명을 입력하세요">
<button onclick="loadChart()">그래프 보기</button>
<div id="stockChart" style="height: 500px;"></div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    function loadChart() {
        const stockName = document.getElementById("stockNameInput").value;
        if (!stockName) {
            alert("종목명을 입력하세요.");
            return;
        }

        fetch(`/stocks/stock_chart_data/?stock_name=${encodeURIComponent(stockName)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }

                const trace = {
                    x: data.date,
                    open: data.open,
                    high: data.high,
                    low: data.low,
                    close: data.close,
                    type: 'candlestick',
                    xaxis: 'x',
                    yaxis: 'y'
                };

                const layout = {
                    title: `${stockName} 차트`,
                    dragmode: 'zoom',
                    showlegend: false,
                    xaxis: {
                        rangeslider: { visible: false },
                        tickformat: "%Y.%m.%d"
                    }
                };

                const config = {
                    displayModeBar: false
                };

                Plotly.newPlot('stockChart', [trace], layout, config);
            })
            .catch(err => {
                alert("데이터를 불러오지 못했습니다.");
                console.error(err);
            });
    }
</script>

{% endblock %}