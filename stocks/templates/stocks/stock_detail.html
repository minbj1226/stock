{% extends "base.html" %}
{% load humanize %}

{% block content %}
<style>
  .tab-btn {
    all: unset; /* Î≤ÑÌäº Ïä§ÌÉÄÏùº Ï¥àÍ∏∞Ìôî */
    cursor: pointer;
    padding: 8px 12px;
    font-size: 15px;
    color: #4b4b4b;
  }

  .tab-btn.active {
    font-weight: bold;
    color: #000;
    background-color: #e5e7eb;
    border-radius: 9999px;
  }

  .tab-wrapper {
    display: flex;
    gap: 20px;
    border-bottom: 1px solid #ddd;
    padding-bottom: 6px;
  }
</style>

<div class="container mt-4">

  <!-- ÏãúÏû•/ÏÑπÌÑ∞/ÏÇ∞ÏóÖ -->
  <div class="mb-2 text-muted small">
    <span class="badge bg-success me-1">{{ stock.market }}</span>
  </div>

  <!-- Ï¢ÖÎ™©Î™Ö / Ìã∞Ïª§ / Í∞ÄÍ≤© -->
  <div class="d-flex align-items-end justify-content-between mb-2">
    <div>
      <h4 class="mb-0 fw-bold">{{ stock.corp_name }}</h4>
      <small class="text-muted">{{ stock.ticker }}</small>
    </div>
    <div class="text-end">
      <div class="fw-bold" style="font-size: 22px;">
        {{ stock.stck_prpr|intcomma }}Ïõê
      </div>
      {% if stock.change %}
        <div class="{% if stock.change > 0 %}text-danger{% elif stock.change < 0 %}text-primary{% else %}text-muted{% endif %}" style="font-size: 14px;">
          {% if stock.change > 0 %}+{% endif %}{{ stock.change|intcomma }}Ïõê ({{ stock.change_rate|floatformat:2 }}%)
        </div>
      {% endif %}
    </div>
  </div>

  <!-- ÏßÄÌëú -->
  <div class="d-flex gap-4 text-center border-top border-bottom py-2 mt-3">
    <div>
      <div class="fw-bold">
        <span class="fw-bold" data-bs-toggle="tooltip" title="PER(Ï£ºÍ∞ÄÏàòÏùµÎπÑÏú®): Ï£ºÍ∞Ä √∑ Ï£ºÎãπÏàúÏù¥Ïùµ(EPS). ÎÇÆÏùÑÏàòÎ°ù Ï†ÄÌèâÍ∞Ä Í∞ÄÎä•ÏÑ±.">PER</span>
      </div>
      <div>{{ stock.per }}</div>
    </div>

    <div>
      <div class="fw-bold">
        <span class="fw-bold" data-bs-toggle="tooltip" title="PBR(Ï£ºÍ∞ÄÏàúÏûêÏÇ∞ÎπÑÏú®): Ï£ºÍ∞Ä √∑ Ï£ºÎãπÏàúÏûêÏÇ∞(BPS). 1Î≥¥Îã§ ÎÇÆÏúºÎ©¥ ÏûêÏÇ∞ ÎåÄÎπÑ Ï†ÄÌèâÍ∞Ä.">PBR</span>
      </div>
      <div>{{ stock.pbr }}</div>
    </div>

    <div>
      <div class="fw-bold">
        <span class="fw-bold" data-bs-toggle="tooltip" title="EPS(Ï£ºÎãπÏàúÏù¥Ïùµ): Í∏∞ÏóÖÏùò ÏàúÏù¥ÏùµÏùÑ Ï£ºÏãù ÏàòÎ°ú ÎÇòÎàà Í∞í. ÎÜíÏùÑÏàòÎ°ù ÏàòÏùµÏÑ± Ï¢ãÏùå.">EPS</span>
      </div>
      <div>{{ stock.eps|floatformat:2|intcomma }}</div>
    </div>

    <div>
      <div class="fw-bold">
        <span class="fw-bold" data-bs-toggle="tooltip" title="BPS(Ï£ºÎãπÏàúÏûêÏÇ∞): Í∏∞ÏóÖÏùò ÏûêÏÇ∞Í∞ÄÏπòÎ•º Ï£ºÏãù ÏàòÎ°ú ÎÇòÎàà Í∞í. PBR Í≥ÑÏÇ∞Ïóê ÏÇ¨Ïö©Îê®.">BPS</span>
      </div>
      <div>{{ stock.bps|floatformat:2|intcomma }}</div>
    </div>
  </div>

  <!-- üîπ ÌÉ≠ Î≤ÑÌäº -->
  <div class="tab-wrapper">
    <button class="tab-btn active" data-tab="chartTab">Ï∞®Ìä∏</button>
    <button class="tab-btn" data-tab="newsTab">Îâ¥Ïä§</button>
  </div>

  <!-- üîπ Ï∞®Ìä∏ ÏòÅÏó≠ -->
  <div id="chartTab" class="tab-content mt-4" style="display: block;">
    <div id="priceChart" style="width: 100%; height: 300px;"></div>
    <div class="mt-2">
      <div id="volumeChart" style="width: 100%; height: 100px;"></div>
    </div>
  </div>

  <!-- üîπ Îâ¥Ïä§ ÏòÅÏó≠ -->
  <div id="newsTab" class="tab-content mt-5" style="display: none;">
    <h5 class="fw-bold mb-3">{{ stock.corp_name }} Îâ¥Ïä§</h5>
    <div id="stockNews" class="d-flex flex-column gap-3">
      {% if news %}
        {% for article in news %}
          <a href="{{ article.link }}" target="_blank" class="text-decoration-none text-dark">
            <div class="p-3 border rounded shadow-sm">
              <strong class="mb-2 d-block">{{ article.title|safe }}</strong>
              <p class="text-muted small mt-2 mb-1">{{ article.description|safe }}</p>
              <p class="text-muted small">{{ article.pubDate }}</p>
            </div>
          </a>
        {% endfor %}
      {% else %}
        <p class="text-muted">Í¥ÄÎ†® Îâ¥Ïä§Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- üîπ Plotly Ï∞®Ìä∏ Ïä§ÌÅ¨Î¶ΩÌä∏ -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
fetch("/stocks/api/chart/{{ stock.ticker }}/")
  .then(res => res.json())
  .then(data => {
    const { date, open, high, low, close, volume } = data;

    const traceCandle = {
      x: date,
      open: open,
      high: high,
      low: low,
      close: close,
      type: 'candlestick',
      name: '',
      xaxis: 'x',
      yaxis: 'y1',
      increasing: { line: { color: '#d33f3f' } },
      decreasing: { line: { color: '#377bd2' } }
    };

    const traceVolume = {
      x: date,
      y: volume,
      type: 'bar',
      name: '',
      yaxis: 'y2',
      marker: {
        color: close.map((c, i) =>
          c >= open[i] ? 'rgba(211, 63, 63, 0.5)' : 'rgba(55, 123, 210, 0.5)'
        )
      }
    };

    const layout = {
      height: 500,
      margin: { t: 10, b: 40, l: 40, r: 10 },
      xaxis: {
        type: 'date',
        tickformat: '%-mÏõî',
        dtick: 'M1',
        tickangle: 0,
        ticks: 'outside',
        ticklen: 4,
        tickfont: { size: 11 },
        showticklabels: true,
        showgrid: false,
        rangeslider: { visible: false }
      },
      yaxis: {
        domain: [0.35, 1],
        showgrid: true,
        tickfont: { size: 10 },
      },
      yaxis2: {
        domain: [0, 0.25],
        showgrid: false,
        tickfont: { size: 10 }
      },
      showlegend: false,
      plot_bgcolor: '#ffffff',
      paper_bgcolor: '#ffffff'
    };

    Plotly.newPlot('priceChart', [traceCandle, traceVolume], layout, {
      displayModeBar: false,
      responsive: true
    });
  });
</script>

<!-- üîπ ÌÉ≠ Ï†ÑÌôò Ïä§ÌÅ¨Î¶ΩÌä∏ -->
<script>
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const targetId = btn.dataset.tab;

      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      document.querySelectorAll('.tab-content').forEach(c => {
        c.style.display = c.id === targetId ? 'block' : 'none';
      });
    });
  });
</script>
{% endblock %}