{% extends "base.html" %}
{% load humanize %}

{% block content %}
<div class="container my-4" style="max-width: 1100px;">

  <!-- ìƒë‹¨ ì¢…ëª© ì°¨íŠ¸ -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h4 id="selectedStockName" class="fw-bold mb-0">ì¢…ëª©ëª…</h4>
          <span id="stockTicker" class="text-muted">000000</span>
        </div>
        <div class="text-end">
          <h4 id="currentPrice" class="fw-bold text-danger">í˜„ì¬ê°€</h4>
          <span class="text-muted" id="priceChangeInfo">+0ì› (+0.00%)</span>
        </div>
      </div>
      <div id="stockChart" style="height: 350px;"></div>
    </div>
  </div>

  <div class="row g-4">
    <!-- ì£¼ë¬¸ ì¹´ë“œ -->
    <div class="col-md-5">
      <div class="card shadow-sm h-100">
        <div class="card-header fw-bold bg-light">ğŸ“ ì£¼ë¬¸í•˜ê¸°</div>
        <div class="card-body">
          <form method="post">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit" class="btn btn-danger w-100 mt-3">ë§¤ìˆ˜í•˜ê¸°</button>
          </form>
        </div>
      </div>
    </div>

    <!-- ê³„ì¢Œ ì •ë³´ + ì£¼ë¬¸ë‚´ì—­ -->
    <div class="col-md-7">
      <div class="card mb-4 shadow-sm">
        <div class="card-header fw-bold bg-light">ğŸ“Œ ê³„ì¢Œ ì •ë³´</div>
        <div class="card-body">
          <p>ê³„ì¢Œ ë²ˆí˜¸: <strong>{{ balance_info.account_number }}</strong></p>
          <p>ì˜ˆìˆ˜ê¸ˆ: <strong>{{ balance_info.deposits.KRW.amount|floatformat:0|intcomma }}ì›</strong></p>
          <p>ì´ ë§¤ì… ê¸ˆì•¡: {{ balance_info.purchase_amount|floatformat:0|intcomma }}ì›</p>
          <p>í˜„ì¬ í‰ê°€ ê¸ˆì•¡: {{ balance_info.current_amount|floatformat:0|intcomma }}ì›</p>
          <p>ì´ ìˆ˜ìµ: <span class="{% if balance_info.profit >= 0 %}text-danger{% else %}text-primary{% endif %}">{{ balance_info.profit|floatformat:0|intcomma }}ì›</span></p>
          <p>ì´ ìˆ˜ìµë¥ : {{ balance_info.profit_rate|floatformat:2 }}%</p>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-header fw-bold bg-light">ğŸ“œ ì£¼ë¬¸ ë‚´ì—­</div>
        <div class="card-body">
          {% if orders %}
            <ul class="list-group">
              {% for order in orders %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span>{{ order.stock_name }} ({{ order.quantity }}ì£¼) - {{ order.transaction_type }}</span>
                  <form action="{% url 'mock_investment:cancel_order' order.id %}" method="post" onsubmit="return confirm('ì •ë§ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-secondary">ì·¨ì†Œ</button>
                  </form>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted">ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</div>

<!-- ì¢…ëª© ì°¨íŠ¸ JS -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
  const stockInput = document.getElementById("id_stock_name");
  stockInput.addEventListener("blur", () => loadChart(stockInput.value));

  function loadChart(stockName) {
    if (!stockName) return;
    fetch(`/mock_investment/stock_chart_data/?stock_name=${encodeURIComponent(stockName)}`)
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          alert(data.error);
          return;
        }

        document.getElementById("selectedStockName").textContent = stockName;
        document.getElementById("stockTicker").textContent = data.ticker || " - ";
        document.getElementById("currentPrice").textContent = data.close.at(-1).toLocaleString() + "ì›";

        const trace = {
          x: data.date,
          y: data.close,
          type: 'scatter',
          mode: 'lines+markers',
          line: { shape: 'linear', color: '#FF3B30' },  // ìƒ‰ìƒì€ ììœ ë¡­ê²Œ ì¡°ì •
          marker: { size: 6 }
        };

        const layout = {
        title: `${stockName} ì£¼ê°€ ì¶”ì´`,
        xaxis: {
        title: 'ë‚ ì§œ',
        tickformat: '%Y-%m-%d'
        },
        yaxis: {
        title: 'ì¢…ê°€ (ì›)'
        },
        margin: { t: 40 }
        };

        Plotly.newPlot("stockChart", [trace], layout, { displayModeBar: false });
      })
      .catch(err => console.error(err));
  }
</script>
{% endblock %}
